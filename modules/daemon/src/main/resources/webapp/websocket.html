<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>WebSocket Test</title>
    <style type="text/css">
        body {
            text-align: center;
        }

        svg {
            border: 1px solid #ccc;
            padding: 20px;
        }

        path.arc {
            fill: #fff;
            stroke: #999;
        }

        path.chord {
            fill: none;
            stroke: #336699;
        }
    </style>
    <script src="lib/d3/d3.js" charset="utf-8"></script>
</head>
<body>
<h2>Chord Stabilisation Demo</h2>
</body>
<script language="javascript" type="text/javascript">

    var wsUri = "ws://127.0.0.1:4567/";

    var nodesUri = "http://127.0.0.1:4567/nodes";

    window.onload = function () {

        var w = 600, h = 600;

        var radius = Math.min(w, h) / 2;

        // Chrome 15 bug: <http://code.google.com/p/chromium/issues/detail?id=98951>
        var div = d3.select("body").append("div")
                .style("width", w + "px")
                .style("height", w + "px")
                .style("margin", "0 auto")
                .style("-webkit-backface-visibility", "hidden");

        var svg = div.append("svg:svg")
                .attr("width", w)
                .attr("height", w)
                .append("svg:g")
                .attr("transform", "translate(" + radius + "," + radius + ")");

        svg.append("svg:path")
                .attr("class", "arc")
                .attr("d", d3.svg.arc().outerRadius(radius).innerRadius(0).startAngle(0).endAngle(2 * Math.PI));

        var line = d3.svg.line.radial()
                .interpolate("bundle")
                .tension(0.6)
                .radius(function (d) {
                    return d.radius;
                })
                .angle(function (d) {
                    return d.value / 180 * Math.PI;
                });

        var bundle = d3.layout.bundle();
        var hierarchy = d3.layout.hierarchy();

        d3.json(nodesUri, function (error, json) {
            if (error) {
                alert("Failed to retrieve existing node: " + error)
            } else {
                for (var i = 0; i < json.length; i++) {
                    var node = json[i];
                    var root = {parent: null, radius: 0};
                    var source = {value: node.nodeId, radius: radius, parent: root};
                    var target = {value: node.successorId, radius: radius, parent: root};
                    root.children = [source, target];
                    hierarchy(root);
                    var splines = bundle([
                        {
                            source: source,
                            target: target
                        }
                    ]);

                    var selection = svg.selectAll(".node-" + node.nodeId);
                    if (selection.size() > 0) {
                        selection.attr("d", line(splines[0]));
                    } else {
                        svg.append("svg:path")
                                .attr("class", "chord node-" + node.nodeId)
                                .attr("d", line(splines[0]));
                    }
                }
            }

            var websocket = new WebSocket(wsUri);

            websocket.onclose = function (event) {
                console.log("Connection closed");
            };

            websocket.onError = function (event) {
                console.log(event.data);
            };

            websocket.onmessage = function (event) {
                var json = JSON.parse(event.data);
                if (json.hasOwnProperty('type') && (json.type === 'SuccessorUpdated' || json.type === 'NodeCreated')) {
                    var root = {parent: null, radius: 0};
                    var source = {value: json.nodeId, radius: radius, parent: root};
                    var target = {value: json.successorId, radius: radius, parent: root};
                    root.children = [source, target];
                    hierarchy(root);
                    var splines = bundle([
                        {
                            source: source,
                            target: target
                        }
                    ]);

                    // TODO: This can likely be improved using a data() join
                    var selection = svg.selectAll(".node-" + json.nodeId);
                    if (selection.size() > 0) {
                        selection.attr("d", line(splines[0]));
                    } else {
                        svg.append("svg:path")
                                .attr("class", "chord node-" + json.nodeId)
                                .attr("d", line(splines[0]));
                    }
                }
            }
        });
    }

</script>
</html>
